FROM node:11.15.0

ARG USER_ID
ARG GROUP_ID

RUN userdel node && \
    groupadd --gid ${GROUP_ID} dev && \
    useradd --uid ${USER_ID} -g dev -m dev && \
    mkdir -p /usr/app && chown dev:dev /usr/app && \
    npm install -g ts-node nodemon && \
    apt-get update && apt-get install -y python3-pip

USER dev

WORKDIR /usr/app

ADD package.json package.json
ADD package-lock.json package-lock.json
RUN npm ci

ADD tests/resources/entrypoint.sh /entrypoint.sh
ADD src/python/requirements.txt requirements.txt

RUN pip3 install -r requirements.txt

ADD nodemon.json nodemon.json
ADD tsconfig.json tsconfig.json

# The URL to the Mesos master to retrieve the state from.
ENV MESOS_MASTER_URL=http://localhost:5050

# Put Mesos state in cache every 60 seconds.
ENV MESOS_STATE_CACHE_TIME=60

# Secrets to encrypt session cookie and authorization tokens
ENV SESSION_SECRET=unsecure-session-secret
ENV JWT_SECRET=unsecure-jwt-secret

CMD ["/entrypoint.sh"]
